<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü¶∑ Âà∑ÁâôÁãÄÊ≥ÅÊúàÂ†±Ë°®</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <style>
        body { 
            font-family: 'Nunito', 'Noto Sans TC', sans-serif; 
            background: linear-gradient(135deg, #dcfce7 0%, #e0f2fe 100%); 
            margin: 0; 
            padding: 20px; 
            display: flex; 
            justify-content: center;
            height: 100vh; 
            box-sizing: border-box; 
        }

        .container { 
            width: 100%;
            max-width: 1400px; 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(10px);
            padding: 25px; 
            border-radius: 20px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.08); 
            display: flex;
            flex-direction: column;
        }

        /* --- È†ÇÈÉ®ÊéßÂà∂ÂçÄ --- */
        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        h2 { 
            margin: 0; 
            color: #2c3e50; 
            font-size: 1.8rem;
            font-weight: 700;
        }

        .controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        /* ÂÖ®Êñ∞ÔºöÊúà‰ªΩÂø´Êç∑ÂàáÊèõÂ∞éËà™ÂçÄ */
        .month-nav {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f8fafc;
            padding: 6px 12px;
            border-radius: 20px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }

        .month-nav label {
            font-weight: 700;
            color: #475569;
            margin-right: 5px;
        }

        .nav-btn {
            background: #e2e8f0;
            border: none;
            border-radius: 8px;
            padding: 6px 10px;
            cursor: pointer;
            color: #475569;
            font-size: 0.9rem;
            font-weight: bold;
            transition: 0.2s;
        }
        
        .nav-btn:hover {
            background: #cbd5e1;
            color: #0f172a;
        }

        input[type="month"] {
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            padding: 6px 10px;
            font-family: inherit;
            font-size: 1.05rem;
            color: #334155;
            outline: none;
            cursor: pointer;
            text-align: center;
            font-weight: bold;
        }
        
        input[type="month"]:hover, input[type="month"]:focus {
            border-color: #93c5fd;
            box-shadow: 0 0 0 3px rgba(147, 197, 253, 0.3);
        }

        #status-msg {
            color: #f59e0b;
            font-weight: bold;
            font-size: 0.95rem;
            background: #fff8e1;
            padding: 6px 15px;
            border-radius: 20px;
        }

        /* --- Ë°®Ê†ºÂçÄ --- */
        .table-responsive {
            flex: 1;
            overflow: auto;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.02);
        }

        table { 
            width: 100%; 
            border-collapse: separate; 
            border-spacing: 0;
            min-width: 1200px; 
        }

        th, td { 
            text-align: center; 
            padding: 6px 2px; 
            border-bottom: 1px solid #edf2f7;
            border-right: 1px solid #f1f5f9;
            height: 40px;
        }
        
        th { 
            background-color: #f8fafc; 
            position: sticky; 
            top: 0; 
            z-index: 10; 
            font-size: 0.9rem; 
            color: #475569; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }

        td:first-child, th:first-child { 
            background-color: #f8fafc; 
            position: sticky; 
            left: 0; 
            z-index: 20; 
            font-weight: 700; 
            color: #334155;
            border-right: 2px solid #cbd5e1;
            min-width: 100px;
        }
        th:first-child { z-index: 30; } 
        
        td:last-child, th:last-child {
            background-color: #f0fdf4;
            position: sticky;
            right: 0;
            z-index: 20;
            font-weight: bold;
            color: #16a34a;
            border-left: 2px solid #bbf7d0;
            min-width: 60px;
        }
        th:last-child { z-index: 30; background-color: #dcfce7; }

        tbody tr:hover td { background-color: #f1f5f9; }
        tbody tr:hover td:first-child { background-color: #e2e8f0; }
        tbody tr:hover td:last-child { background-color: #dcfce7; }

        .sym-check { color: #22c55e; font-weight: bold; font-size: 1.2rem;}
        .sym-cross { color: #ef4444; font-weight: bold; font-size: 1.2rem;}
        .sym-triangle { color: #f59e0b; font-weight: bold; font-size: 1.2rem;}
        .sym-none { color: #cbd5e1; font-size: 0.8rem; } 
        
        /* ÈÄ±Êú´ÁâπÂà•Ê®ôÁ§∫ */
        .weekend { background-color: #fff1f2 !important; }

    </style>
</head>
<body>

    <div class="container">
        <div class="header-section">
            <h2>ü¶∑ Áè≠Á¥öÂà∑ÁâôÊúàÂ†±Ë°®</h2>
            
            <div class="controls">
                <div id="status-msg">Ë´ãÁ®çÂÄô...</div>
                
                <div class="month-nav">
                    <label>üìÖ</label>
                    <button class="nav-btn" onclick="changeMonth(-1)" title="‰∏äÂÄãÊúà">‚óÄ</button>
                    <input type="month" id="monthPicker" onchange="loadMonthlyData()">
                    <button class="nav-btn" onclick="changeMonth(1)" title="‰∏ãÂÄãÊúà">‚ñ∂</button>
                </div>
            </div>
        </div>

        <div class="table-responsive">
            <table id="reportTable">
                <thead>
                    <tr id="tableHeader">
                        </tr>
                </thead>
                <tbody id="tableBody">
                    </tbody>
            </table>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAZzLxfBuVCb_bF63D8yd8BqFKYUAfiF30",
            authDomain: "class-record-grid.firebaseapp.com",
            projectId: "class-record-grid",
            storageBucket: "class-record-grid.firebasestorage.app",
            messagingSenderId: "643634349640",
            appId: "1:643634349640:web:969496a4c416cc63793a7d"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        let studentList = [];

        window.onload = async function() { 
            // È†êË®≠Êúà‰ªΩÁÇ∫Áï∂‰∏ãÈÄôÂÄãÊúà
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            document.getElementById('monthPicker').value = `${yyyy}-${mm}`;

            document.getElementById('status-msg').innerText = "ËºâÂÖ•ÂêçÂñÆ‰∏≠...";
            try {
                const docSnap = await db.collection("class_records").doc("student_list").get();
                if (docSnap.exists) {
                    studentList = docSnap.data().list || [];
                    studentList.sort((a, b) => parseInt(a.no) - parseInt(b.no));
                }
                
                // ÂêçÂñÆËºâÂÖ•ÂÆåÁï¢ÂæåÔºåËá™ÂãïÊäìÂèñÈÄôÂÄãÊúàÁöÑÂ†±Ë°®
                loadMonthlyData();
            } catch (error) {
                document.getElementById('status-msg').innerText = "ÂêçÂñÆËºâÂÖ•Â§±ÊïóÔºåË´ãÊ™¢Êü•Á∂≤Ë∑Ø„ÄÇ";
                document.getElementById('status-msg').style.color = "red";
            }
        };

        // --- ÂÖ®Êñ∞ÔºöÂâçÂæåÊúà‰ªΩÂàáÊèõÂäüËÉΩ ---
        function changeMonth(offset) {
            const picker = document.getElementById('monthPicker');
            if (!picker.value) return;

            // ÊãÜËß£ YYYY-MM
            const parts = picker.value.split('-');
            let year = parseInt(parts[0], 10);
            let month = parseInt(parts[1], 10);

            // Âä†‰∏äÊàñÊ∏õÂéªÊúà‰ªΩ
            month += offset;

            // ËôïÁêÜË∑®Âπ¥ÁöÑÊÉÖÊ≥Å
            if (month > 12) {
                month = 1;
                year += 1;
            } else if (month < 1) {
                month = 12;
                year -= 1;
            }

            // ÁµÑË£ùÂõûÂ≠ó‰∏≤‰∏¶Êõ¥Êñ∞Ëº∏ÂÖ•Ê°Ü
            const yyyy = year;
            const mm = String(month).padStart(2, '0');
            picker.value = `${yyyy}-${mm}`;

            // Ëá™ÂãïËºâÂÖ•Êñ∞Êúà‰ªΩÁöÑË≥áÊñô
            loadMonthlyData();
        }

        function getDaysInMonth(year, month) {
            return new Date(year, month, 0).getDate();
        }

        function isWeekend(year, month, day) {
            const date = new Date(year, month - 1, day);
            const dayOfWeek = date.getDay();
            return dayOfWeek === 0 || dayOfWeek === 6; 
        }

        async function loadMonthlyData() {
            if (studentList.length === 0) {
                alert("Â∞öÊú™Âª∫Á´ãÂ≠∏ÁîüÂêçÂñÆÔºÅ");
                return;
            }

            const monthValue = document.getElementById('monthPicker').value;
            if (!monthValue) return;

            const [yearStr, monthStr] = monthValue.split('-');
            const year = parseInt(yearStr);
            const month = parseInt(monthStr);
            const daysCount = getDaysInMonth(year, month);

            const statusMsg = document.getElementById('status-msg');
            statusMsg.innerText = "‚è≥ Èõ≤Á´ØË≥áÊñôÊäìÂèñ‰∏≠...";
            statusMsg.style.color = "#f59e0b";
            statusMsg.style.background = "#fff8e1";

            const promises = [];
            const dateStrings = [];

            // ÊâπÊ¨°Ê∫ñÂÇôÊäìÂèñÊï¥ÂÄãÊúà‰ªΩÁöÑÊ™îÊ°à
            for (let i = 1; i <= daysCount; i++) {
                const dd = String(i).padStart(2, '0');
                const dateStr = `${yearStr}-${monthStr}-${dd}`;
                dateStrings.push(dateStr);
                promises.push(db.collection("class_records").doc(`grid_${dateStr}`).get());
            }

            try {
                const snapshots = await Promise.all(promises);
                const monthlyData = {}; 

                snapshots.forEach((snap, idx) => {
                    const dateStr = dateStrings[idx];
                    if (snap.exists) {
                        monthlyData[dateStr] = snap.data().data || {};
                    } else {
                        monthlyData[dateStr] = {}; 
                    }
                });

                renderReport(year, month, daysCount, dateStrings, monthlyData);

                statusMsg.innerText = "‚úÖ Â†±Ë°®Áî¢ÁîüÂÆåÊàê";
                statusMsg.style.color = "#059669";
                statusMsg.style.background = "#d1fae5";

            } catch (error) {
                console.error(error);
                statusMsg.innerText = "‚ùå Ë≥áÊñôËºâÂÖ•Â§±Êïó";
                statusMsg.style.color = "#ef4444";
                statusMsg.style.background = "#fee2e2";
            }
        }

        function renderReport(year, month, daysCount, dateStrings, monthlyData) {
            const theadTr = document.getElementById('tableHeader');
            const tbody = document.getElementById('tableBody');
            
            // Ë°®È†≠
            let theadHtml = '<th>Â∫ßËôü / ÂßìÂêç</th>';
            for (let i = 1; i <= daysCount; i++) {
                const weekendClass = isWeekend(year, month, i) ? 'class="weekend"' : '';
                theadHtml += `<th ${weekendClass}>${i}Êó•</th>`;
            }
            theadHtml += '<th>‚úî Á∏ΩË®à</th>';
            theadTr.innerHTML = theadHtml;

            // Ë≥áÊñô
            let tbodyHtml = '';
            
            studentList.forEach(student => {
                const safeId = student.id || student.no;
                let checkCount = 0; 

                tbodyHtml += `<tr><td>${student.no}. ${student.name}</td>`;

                for (let i = 0; i < daysCount; i++) {
                    const dateStr = dateStrings[i];
                    // Âú®ÂéüÊú¨ÁöÑË°®Ê†º‰∏≠Ôºå„ÄåÂà∑Áâô„ÄçÂõ∫ÂÆöÂú®Á¨¨ 2 Ê¨Ñ
                    const cellKey = `${safeId}-2`; 
                    const cellData = monthlyData[dateStr][cellKey];
                    
                    let symbolHtml = '<span class="sym-none">-</span>'; 
                    const weekendClass = isWeekend(year, month, i + 1) ? 'weekend' : '';

                    if (cellData) {
                        if (cellData.className.includes('color-check')) {
                            symbolHtml = '<span class="sym-check">‚úî</span>';
                            checkCount++; 
                        } else if (cellData.className.includes('color-cross')) {
                            symbolHtml = '<span class="sym-cross">‚úò</span>';
                        } else if (cellData.className.includes('color-triangle')) {
                            symbolHtml = '<span class="sym-triangle">‚ñ≤</span>';
                        }
                    }

                    tbodyHtml += `<td class="${weekendClass}">${symbolHtml}</td>`;
                }

                tbodyHtml += `<td>${checkCount}</td></tr>`;
            });

            tbody.innerHTML = tbodyHtml;
        }
    </script>
</body>
</html>