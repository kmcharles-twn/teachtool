<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“ ç”Ÿæ´»å¸¸è¦æ™‚æˆ³ç™»è¨˜è¡¨</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <style>
        body { 
            font-family: 'Nunito', 'Noto Sans TC', sans-serif; 
            background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%); 
            margin: 0; 
            padding: 20px; 
            display: flex; 
            gap: 20px; 
            height: 100vh; 
            box-sizing: border-box; 
        }

        .main-content { 
            flex: 1; 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(10px);
            padding: 25px; 
            border-radius: 20px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.08); 
            overflow: auto; 
            display: flex;
            flex-direction: column;
        }

        h2 { 
            margin: 0 0 15px 0; 
            color: #2c3e50; 
            font-size: 1.8rem;
            font-weight: 700;
            letter-spacing: 1px;
            text-align: left; /* ç§»è‡³å·¦å´ï¼Œè®“ç‰ˆé¢æ›´ç©©é‡ */
        }

        /* --- è¡¨æ ¼å€ --- */
        table { 
            width: 100%; 
            border-collapse: separate; 
            border-spacing: 0;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
        }

        th, td { 
            text-align: center; 
            padding: 8px; 
            min-width: 90px; 
            height: 60px; 
            vertical-align: middle; 
            border-bottom: 1px solid #edf2f7;
            border-right: 1px dashed #e2e8f0;
        }
        
        th:last-child, td:last-child { border-right: none; }
        tr:last-child td { border-bottom: none; }

        th { 
            position: sticky; 
            top: 0; 
            z-index: 10; 
            height: 45px; 
            font-size: 1.1rem; 
            color: #475569; 
            font-weight: 700;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }

        td:first-child, th:first-child { 
            background-color: #f8fafc; 
            position: sticky; 
            left: 0; 
            z-index: 20; 
            font-weight: 700; 
            color: #334155;
            cursor: default; 
            border-right: 2px solid #e2e8f0;
        }
        th:first-child { z-index: 30; } 

        /* å„æ¬„ä½å°ˆå±¬åº•è‰² */
        th:nth-child(2) { background-color: #ffedd5; }
        td:nth-child(2) { background-color: #fff7ed; }
        td.clickable:nth-child(2):hover { background-color: #ffedd5; box-shadow: inset 0 0 0 2px #fdba74; }

        th:nth-child(3) { background-color: #dcfce7; }
        td:nth-child(3) { background-color: #f0fdf4; }
        td.clickable:nth-child(3):hover { background-color: #dcfce7; box-shadow: inset 0 0 0 2px #86efac; }

        th:nth-child(4) { background-color: #e0f2fe; }
        td:nth-child(4) { background-color: #f0f9ff; }
        td.clickable:nth-child(4):hover { background-color: #e0f2fe; box-shadow: inset 0 0 0 2px #7dd3fc; }

        th:nth-child(5) { background-color: #f3e8ff; }
        td:nth-child(5) { background-color: #faf5ff; }
        td.clickable:nth-child(5):hover { background-color: #f3e8ff; box-shadow: inset 0 0 0 2px #d8b4fe; }

        td.clickable { cursor: pointer; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }

        .cell-content { display: flex; flex-direction: column; align-items: center; justify-content: center; line-height: 1.1; }
        .symbol-mark { font-size: 1.6rem; font-weight: bold; margin-bottom: 2px; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1)); }
        .datetime-tag { font-size: 0.7rem; color: #64748b; background-color: rgba(255, 255, 255, 0.7); padding: 2px 7px; border-radius: 12px; white-space: nowrap; font-weight: 500; border: 1px solid rgba(0,0,0,0.05); }

        /* --- å´é‚Šæ¬„ --- */
        .sidebar { 
            width: 170px; /* åŠ å¯¬ä¸€é»å®¹ç´æ—¥æœŸåˆ‡æ›å™¨ */
            display: flex; flex-direction: column; gap: 12px; 
            padding: 20px 15px; background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(10px); border-radius: 20px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.08); height: fit-content; 
        }

        .section-title { text-align: center; color: #94a3b8; font-size: 0.85rem; font-weight: 700; margin-bottom: 2px; letter-spacing: 1px; }

        /* --- æ—¥æœŸé¸æ“‡å™¨èˆ‡ç‹€æ…‹ --- */
        .date-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 4px;
        }

        .date-nav button {
            background: #f1f5f9;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            padding: 6px 8px;
            cursor: pointer;
            color: #475569;
            font-size: 0.8rem;
            transition: 0.2s;
        }
        
        .date-nav button:hover { background: #e2e8f0; color: #0f172a; }

        .date-nav input[type="date"] {
            flex: 1;
            width: 100%;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            padding: 5px 2px;
            font-family: inherit;
            font-size: 0.8rem;
            color: #334155;
            outline: none;
            cursor: pointer;
            text-align: center;
        }

        #sync-status { 
            text-align: center; 
            font-size: 0.75rem; 
            color: #f39c12; 
            font-weight: 700;
            background: #fff8e1;
            padding: 4px 8px;
            border-radius: 12px;
            margin-top: -5px;
        }

        /* --- ç«‹é«”æµ®é›•æŒ‰éˆ• --- */
        .tool-btn, .action-btn { 
            padding: 8px; cursor: pointer; border: 2px solid transparent; 
            border-radius: 14px; background-color: #ffffff; transition: all 0.25s ease; 
            text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.04); border: 1px solid #f1f5f9;
        }

        .tool-btn:hover, .action-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.08); border-color: #e2e8f0; }
        .tool-btn.active { border-color: #4CAF50; background-color: #f0fdf4; box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2), 0 4px 6px rgba(0,0,0,0.05); }
        
        .btn-symbol { font-size: 1.4rem; margin-bottom: 2px; }
        .btn-text { font-size: 0.85rem; color: #475569; font-weight: 700; }
        .action-btn { margin-top: 2px; flex-direction: row; gap: 6px; padding: 10px 8px; }
        
        .btn-export { background: linear-gradient(145deg, #e0f2fe, #bae6fd); color: #0369a1; border: none; }
        .btn-export .btn-text { color: #0369a1; }
        .btn-export:hover { background: linear-gradient(145deg, #bae6fd, #7dd3fc); }

        .btn-clear { background: linear-gradient(145deg, #fee2e2, #fecaca); color: #b91c1c; border: none; }
        .btn-clear .btn-text { color: #b91c1c; }
        .btn-clear:hover { background: linear-gradient(145deg, #fecaca, #fca5a5); }

        hr { width: 80%; border: 0; border-top: 2px dashed #e2e8f0; margin: 5px auto; }
        .color-check { color: #22c55e; } .color-cross { color: #ef4444; } .color-triangle { color: #f59e0b; } 
        .empty-notice { color: #94a3b8; padding: 40px; font-size: 1.1rem; font-weight: 500; }
    </style>
</head>
<body>

    <div class="main-content">
        <h2>âœ¨ ç”Ÿæ´»å¸¸è¦æª¢æ ¸è¡¨</h2>
        <table id="recordTable">
            <thead></thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="sidebar">
        <div class="section-title">ğŸ“… æ—¥æœŸç®¡ç†</div>
        <div class="date-nav">
            <button onclick="changeDate(-1)" title="å‰ä¸€æ—¥">â—€</button>
            <input type="date" id="recordDate">
            <button onclick="changeDate(1)" title="å¾Œä¸€æ—¥">â–¶</button>
        </div>
        <div id="sync-status">é€£ç·šä¸­...</div>

        <hr>

        <div class="section-title">ç™»è¨˜å·¥å…·</div>
        <button class="tool-btn color-check active" onclick="selectTool('âœ”', this)">
            <span class="btn-symbol">âœ”</span><span class="btn-text">å®Œæˆ</span>
        </button>
        <button class="tool-btn color-cross" onclick="selectTool('âœ˜', this)">
            <span class="btn-symbol">âœ˜</span><span class="btn-text">æœªå®Œæˆ</span>
        </button>
        <button class="tool-btn color-triangle" onclick="selectTool('â–²', this)">
            <span class="btn-symbol">â–²</span><span class="btn-text">è«‹å‡</span>
        </button>
        <button class="tool-btn" onclick="selectTool('', this)">
            <span class="btn-text" style="font-size:0.95rem; color:#64748b;">ğŸ§¹ æ©¡çš®æ“¦</span>
        </button>

        <hr>

        <div class="section-title">ç›®å‰æ—¥æœŸæª”æ¡ˆ</div>
        <button class="action-btn btn-export" onclick="exportToCSV()">
            <span class="btn-text">ğŸ“¥ åŒ¯å‡º CSV</span>
        </button>
        <button class="action-btn btn-clear" onclick="clearAllData()">
            <span class="btn-text">ğŸ—‘ï¸ æ¸…ç©ºæœ¬æ—¥</span>
        </button>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAZzLxfBuVCb_bF63D8yd8BqFKYUAfiF30",
            authDomain: "class-record-grid.firebaseapp.com",
            projectId: "class-record-grid",
            storageBucket: "class-record-grid.firebasestorage.app",
            messagingSenderId: "643634349640",
            appId: "1:643634349640:web:969496a4c416cc63793a7d"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        const studentRef = db.collection("class_records").doc("student_list"); 
        
        let currentGridRef = null;
        let gridUnsubscribe = null; 
        let currentSymbol = 'âœ”'; 
        const fixedHeaders = ["ç”¨é¤", "åˆ·ç‰™", "æ“¦æ¡Œå­", "æ•´ç†æ›¸åŒ…"];
        
        let studentList = []; 
        let gridData = {};    
        
        const table = document.getElementById('recordTable');
        const statusDiv = document.getElementById('sync-status');
        const datePicker = document.getElementById('recordDate');

        window.onload = function() { 
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const todayStr = `${yyyy}-${mm}-${dd}`;
            datePicker.value = todayStr;

            datePicker.addEventListener('change', (e) => {
                listenToGrid(e.target.value);
            });

            startStudentSync(); 
            listenToGrid(todayStr);
        };

        // --- å‰å¾Œæ—¥åˆ‡æ›åŠŸèƒ½ ---
        function changeDate(offset) {
            if (!datePicker.value) return;

            // å°‡è¼¸å…¥æ¡†çš„ YYYY-MM-DD æ‹†è§£ï¼Œä»¥æœ¬åœ°æ™‚é–“ä¾†åšåŠ æ¸›ï¼Œé¿å…æ™‚å€å•é¡Œè·¨æœˆå‡ºéŒ¯
            const parts = datePicker.value.split('-');
            const year = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10) - 1; 
            const day = parseInt(parts[2], 10);

            const targetDate = new Date(year, month, day);
            targetDate.setDate(targetDate.getDate() + offset);

            const yyyy = targetDate.getFullYear();
            const mm = String(targetDate.getMonth() + 1).padStart(2, '0');
            const dd = String(targetDate.getDate()).padStart(2, '0');
            const newDateStr = `${yyyy}-${mm}-${dd}`;

            datePicker.value = newDateStr;
            listenToGrid(newDateStr); // ç›´æ¥è§¸ç™¼è®€å–é›²ç«¯
        }

        function startStudentSync() {
            studentRef.onSnapshot((docSnap) => {
                if (docSnap.exists) {
                    studentList = docSnap.data().list || [];
                    studentList.sort((a, b) => parseInt(a.no) - parseInt(b.no));
                } else {
                    studentList = [];
                }
                renderTable(); 
            }, (error) => {
                showError("ç„¡æ³•å–å¾—å­¸ç”Ÿåå–®");
            });
        }

        function listenToGrid(dateStr) {
            if (gridUnsubscribe) {
                gridUnsubscribe();
            }

            statusDiv.innerText = "åˆ‡æ›æ—¥æœŸä¸­...";
            statusDiv.style.color = "#f39c12";
            statusDiv.style.background = "#fff8e1";

            currentGridRef = db.collection("class_records").doc(`grid_${dateStr}`);
            
            gridUnsubscribe = currentGridRef.onSnapshot((docSnap) => {
                if (docSnap.exists) {
                    gridData = docSnap.data().data || {};
                } else {
                    gridData = {}; 
                }
                
                if (studentList.length > 0) {
                    updateTableDataOnly();
                }
                updateSyncStatus();
            }, (error) => {
                showError("ç„¡æ³•è®€å–è©²æ—¥ç´€éŒ„");
            });
        }

        function updateSyncStatus() {
            statusDiv.innerText = "ğŸŸ¢ é›²ç«¯åŒæ­¥ä¸­";
            statusDiv.style.color = "#059669";
            statusDiv.style.background = "#d1fae5";
        }

        function showError(msg) {
            statusDiv.innerText = `âš ï¸ ${msg}`;
            statusDiv.style.color = "#ef4444";
            statusDiv.style.background = "#fee2e2";
        }

        function renderTable() {
            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');

            let theadHtml = '<tr><th>åº§è™Ÿ / å§“å</th>';
            fixedHeaders.forEach((h) => { theadHtml += `<th>${h}</th>`; });
            theadHtml += '</tr>';
            thead.innerHTML = theadHtml;

            if (studentList.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${fixedHeaders.length + 1}" class="empty-notice">ğŸ“­ å°šæœªè¨­å®šå­¸ç”Ÿåå–®ï¼Œè«‹å…ˆè‡³ã€Œå­¸ç”Ÿåå–®ç®¡ç†ç³»çµ±ã€æ–°å¢å­¸ç”Ÿã€‚</td></tr>`;
                return;
            }

            let tbodyHtml = '';
            studentList.forEach((student) => {
                const safeId = student.id || student.no;
                tbodyHtml += `<tr data-student-id="${safeId}"><td>${student.no}. ${student.name}</td>`;
                
                for(let j = 1; j <= fixedHeaders.length; j++) {
                    let cellKey = `${safeId}-${j}`;
                    let cellContent = '';
                    let cellClass = 'clickable';
                    
                    if (gridData && gridData[cellKey]) {
                        cellContent = gridData[cellKey].html;
                        cellClass = gridData[cellKey].className;
                    }
                    tbodyHtml += `<td class="${cellClass}" onclick="updateCellLocally(this, '${safeId}', ${j})">${cellContent}</td>`;
                }
                tbodyHtml += '</tr>';
            });
            tbody.innerHTML = tbodyHtml;
        }

        function updateTableDataOnly() {
            const rows = table.querySelector('tbody').rows;
            for (let i = 0; i < rows.length; i++) {
                let studentId = rows[i].getAttribute('data-student-id');
                if (!studentId) continue; 

                for (let j = 1; j <= fixedHeaders.length; j++) {
                    let cellKey = `${studentId}-${j}`;
                    let cell = rows[i].cells[j];
                    if (!cell) continue;

                    if (gridData && gridData[cellKey]) {
                        cell.innerHTML = gridData[cellKey].html;
                        cell.className = gridData[cellKey].className;
                    } else {
                        cell.innerHTML = '';
                        cell.className = 'clickable';
                    }
                }
            }
        }

        function selectTool(symbol, btnElement) {
            currentSymbol = symbol;
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            btnElement.classList.add('active');
        }

        function updateCellLocally(cell, studentId, colIndex) {
            if (currentSymbol === '') {
                cell.innerHTML = '';
                cell.className = 'clickable'; 
            } else {
                const now = new Date();
                const timeStr = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                
                cell.innerHTML = `<div class="cell-content"><span class="symbol-mark">${currentSymbol}</span><span class="datetime-tag">${timeStr}</span></div>`;
                
                cell.className = 'clickable'; 
                if (currentSymbol === 'âœ”') cell.classList.add('color-check');
                if (currentSymbol === 'âœ˜') cell.classList.add('color-cross');
                if (currentSymbol === 'â–²') cell.classList.add('color-triangle');
            }
            saveToFirebase();
        }

        function saveToFirebase() {
            if (!currentGridRef) return; 

            const tbody = table.querySelector('tbody');
            if (!tbody) return; 
            const rows = tbody.rows;
            let newGridData = {};
            
            for (let i = 0; i < rows.length; i++) {
                let studentId = rows[i].getAttribute('data-student-id');
                if (!studentId) continue;

                for (let j = 1; j <= fixedHeaders.length; j++) {
                    let cellKey = `${studentId}-${j}`;
                    let cell = rows[i].cells[j];
                    if (cell && cell.innerHTML.trim() !== '') {
                        newGridData[cellKey] = {
                            html: cell.innerHTML,
                            className: cell.className
                        };
                    }
                }
            }
            currentGridRef.set({ data: newGridData });
        }

        function clearAllData() {
            const selectedDate = datePicker.value;
            if (confirm(`ç¢ºå®šè¦æ¸…é™¤ã€${selectedDate}ã€‘æ‰€æœ‰æ ¼å­å…§çš„ç´€éŒ„å—ï¼Ÿ\n(å…¶ä»–æ—¥æœŸçš„ç´€éŒ„ä¸æœƒå—å½±éŸ¿)`)) {
                currentGridRef.set({ data: {} }); 
            }
        }

        function exportToCSV() {
            let csvContent = "\uFEFF"; 
            const rows = table.querySelectorAll('tr');
            rows.forEach(row => {
                let rowData = [];
                const cols = row.querySelectorAll('th, td');
                cols.forEach(col => {
                    let text = col.innerText.replace(/\n/g, ' '); 
                    rowData.push(`"${text}"`); 
                });
                csvContent += rowData.join(',') + "\r\n";
            });

            const selectedDate = datePicker.value;
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `ç”Ÿæ´»å¸¸è¦ç™»è¨˜è¡¨_${selectedDate}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>